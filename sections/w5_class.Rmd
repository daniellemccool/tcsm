## In-Class Exercises

```{r echo = FALSE}
library(foreign)
#library(semTools)
#library(kableExtra)
library(lavaan)
#library(psych)
library(dplyr)

#dataDir <- "../../data/"
seData <- read.spss(paste0(dataDir, "SelfEsteem.sav"), to.data.frame = TRUE)
```

To begin this practical, recall the path model that we estimated for the 
[At-Home Exercises](at-home-exercises-3.html).

![](images/week5_home_full_model.png)

Further, recall the research questions for our analysis.

1. Better peer relationships will promote higher self-esteem via a three-step 
indirect process.
    a. Better peer relationships will increase empathy levels.
    a. Higher empathy will increase prosocial behavior and decrease aggressive 
    behavior.
    a. More prosocial behaviors and less aggressive behavior will both produce 
    higher self-esteem.
1. Better relationships with parents directly increase self-esteem.

Clearly, we have estimated more paths than we need to directly assess the 
hypotheses. We could still calculate the relevant direct/indirect/total effects 
from a simpler model.

---

### {#diagram}

Draw a path diagram for the simplest model that you could use to define the 
effects implied by the above hypotheses.

- For the purposes of testing the final hypothesis, you may treat *direct* and 
*total* effects as synonymous.
- Keep the covariances between `ParAtt` and `PeerAtt` and between `ProSoc` and 
`Aggr` in the model.

<details>
  <summary>Click for explanation</summary>

![](images/week5_home_res_model.png)

</details>

---

### {#resMod}

Define the **lavaan** model syntax for the path model you diagrammed in 
\@ref(diagram).

- Label any relevant paths
- Specify any relevant indirect effects as defined parameters. 
- Save the syntax string as an object in your environment.

<details>
  <summary>Click for explanation</summary>

```{r}
resMod <- '
## Equation for outcome:
SelfEst ~ y_m21 * ProSoc + y_m22 * Aggr + ParAtt

## Equations for stage 2 mediators:
ProSoc ~ m21_m1 * Emp
Aggr ~ m22_m1 * Emp

## Equation for stage 1 mediator:
Emp ~ m1_x2 * PeerAtt

## Covariances:
ProSoc ~~ Aggr
ParAtt ~~ PeerAtt

## Indirect effects:
ie_pro := m1_x2 * m21_m1 * y_m21
ie_agg := m1_x2 * m22_m1 * y_m22
'
```

</details>

---

### {#estimateRes}

Estimate the model defined in \@ref(resMod) using 1000 bootstrap samples.

- Other than the `se` and `bootstrap` options, use the defaults.
- How does the model fit?
- Is the hypothesized total/direct effect from `ParAtt` to `SelfEst` significant?
- Are the hypothesized IEs significant according to the one-tailed 95% bootstrap CIs?

<details>
  <summary>Click for explanation</summary>

```{r res_boot_estimate, cache = TRUE}
## Set a seed to get replicable bootstrap samples:
set.seed(235711)

## Estimate the restricted model with bootstrapping:
out_res <- sem(resMod, data = seData, se = "bootstrap", bootstrap = 1000)

## Summarize the model:
summary(out_res, fit.measures = TRUE)

## Compute CIs:
parameterEstimates(out_res, ci = TRUE, level = 0.9)
```

```{r, include = FALSE}
tmp <- summary(out_res)$pe
par <- tmp %>% filter(op == "~", rhs == "ParAtt")

tmp <- parameterEstimates(out_res, ci = TRUE, level = 0.9)
pro <- tmp %>% filter(label == "ie_pro")
agg <- tmp %>% filter(label == "ie_agg")
```

- The fit of the model is marginal. The $\chi^2$ is pretty small and the CFI 
looks good, but the TLI is below the threshold of acceptable fit. The RMSEA and 
SRMR are toward the upper end of the range for "acceptable" fit.

- Yes, the total effect of *Parent Attachment* on *Self Esteem*  is significant 
(
$\beta = `r par$est %>% round(3)`$, 
$Z = `r par$z %>% round(2)`$,
$p < 0.001$
).

- The IE of *Peer Attachment* on *Self Esteem* through *Empathy* and *Prosocial 
Behavior* is significant (
$\beta = `r pro$est %>% round(3)`$, 
$95\% ~ CI = [`r pro$ci.lower %>% round(3)`; \infty]$
), as is the analogous IE through *Aggressive Behavior* (
$\beta = `r agg$est %>% round(3)`$, 
$95\% ~ CI = [-\infty; `r agg$ci.upper %>% round(3)`]$
).

</details>

---

###

Re-estimate the model from \@ref(boot) in the At-Home Exercises.

- Use B = 1000 bootstrap samples.
- Other than the `se` and `bootstrap` options, use the defaults.
- Does this model give the same answers (vis-รก-vis the hypotheses) as the 
restricted model from \@ref(estimateRes)?

<details>
  <summary>Click for explanation</summary>

```{r full_boot_estimate, cache = TRUE}
## Define the model syntax:
fullMod <- '
## Equation for outcome:
SelfEst ~ y_m21 * ProSoc + y_m22 * Aggr + Emp + ParAtt + PeerAtt

## Equations for stage 2 mediators:
ProSoc ~ m21_x2 * PeerAtt + ParAtt + m21_m1 * Emp
Aggr ~ m22_x2 * PeerAtt + ParAtt + m22_m1 * Emp

## Equation for stage 1 mediator:
Emp ~ ParAtt + m1_x2 * PeerAtt

## Covariances:
ProSoc ~~ Aggr
ParAtt ~~ PeerAtt

## Indirect effects:
ie_pro := m1_x2 * m21_m1 * y_m21
ie_agg := m1_x2 * m22_m1 * y_m22
'
## Set a seed to get replicable bootstrap samples:
set.seed(235711)

## Estimate the model with bootstrapping:
out_full <- sem(fullMod, data = seData, se = "bootstrap", bootstrap = 1000)

## Summarize the model:
summary(out_full)
parameterEstimates(out_full, ci = TRUE, level = 0.9)
```

Although the estimates differ somewhat, the inferential conclusions are 
more-or-less the same whether we estimate the effects with the full or the 
restricted model.

- The meaning of these effects are not identical though.
- We are partialing out the effects of more variables in the full model.

</details>

---

If you found that the inferential conclusions were the same in the full and 
restricted models, considerations of parsimony may be tempt you to base your 
conclusions on the restricted model. However, to do so at this point would be 
premature.

We must first show that the restricted model is an equally good representation 
of the data. The restricted model is nested within the full model, so we can use
a $\Delta \chi^2$ test to evaluate the loss of fit.

---

###

Conduct a $\Delta \chi^2$ test to check if the restricted model still fits 
sufficiently well.

- What do you conclude?
- Do you notice anything about the relation between the $\Delta \chi^2$ in this 
test and the $\chi^2$ model fit statistic from \@ref(estimateFull)?

*Hint:* You can use the `anova()` function to conduct a $\Delta \chi^2$ test 
between two fitted **lavaan** objects.

<details>
  <summary>Click for explanation</summary>

```{r}
anova(out_full, out_res)
```

- The $\Delta \chi^2$ is significant, so we should not prefer the restricted 
model. Constraining the full model has produced too much loss of fit.
- The $\Delta \chi^2$ (and it's associated degrees of freedom and p-value) is
identical to the model fit statistic from \@ref(estimateRes). Of course, we should
not find this surprising. Since the full model is saturated, it has $\chi^2 = 0$.
So, our $\Delta \chi^2$ statistic was computed by sutracting zero from the $\chi^2$
for the restricted model. Hence, we didn't really need to do this test; we 
already had the answer.

</details>

---

Recall the four different flavors of effect that we can define in a multiple 
mediation model.

1. Total effect
1. Direct effect
1. Specific indirect effect
1. Total indirect effect

Take note of the following points.

- If we have multiple inputs and/or outcomes, we can each pair of X and Y will
be linked through a set of these four effects.
- If any of the multiple mediators are arranged serially in the process these 
four flavors of effect can connect an input to a mediator, connect a mediator 
to an outcome, or connect two mediators.  

So, we can define many different effects when working with complicated process 
models.

---

###

List all possible effects (i.e., direct, total, [specific/total] indirect) that 
we can define based on the full model represented in XXX.

- Do not include the paths that attach variables that are adjacent in the process 
(e.g., a and b paths).

<details>
  <summary>Click for explanation</summary>

***Three-Step Specific Indirect Effects***

1. *Parent Attachment* $\rightarrow$ *Empathy* $\rightarrow$ *Prosocial Behavior*
$\rightarrow$ *Self Esteem*
1. *Parent Attachment* $\rightarrow$ *Empathy* $\rightarrow$ *Aggressive Behavior*
$\rightarrow$ *Self Esteem*
1. *Peer Attachment* $\rightarrow$ *Empathy* $\rightarrow$ *Prosocial Behavior*
$\rightarrow$ *Self Esteem*
1. *Peer Attachment* $\rightarrow$ *Empathy* $\rightarrow$ *Aggressive Behavior*
$\rightarrow$ *Self Esteem*

***Two-Step Specific Indirect Effects***

1. *Parent Attachment* $\rightarrow$ *Empathy* $\rightarrow$ *Self Esteem*

1. *Parent Attachment* $\rightarrow$ *Prosocial Behavior* $\rightarrow$ *Self Esteem*
1. *Parent Attachment* $\rightarrow$ *Empathy* $\rightarrow$ *Prosocial Behavior*
1. *Empathy* $\rightarrow$ *Prosocial Behavior* $\rightarrow$ *Self Esteem*

1. *Parent Attachment* $\rightarrow$ *Aggressive Behavior* $\rightarrow$ *Self Esteem*
1. *Parent Attachment* $\rightarrow$ *Empathy* $\rightarrow$ *Aggressive Behavior*
1. *Empathy* $\rightarrow$ *Aggressive Behavior* $\rightarrow$ *Self Esteem*

1. *Peer Attachment* $\rightarrow$ *Empathy* $\rightarrow$ *Self Esteem*

1. *Peer Attachment* $\rightarrow$ *Prosocial Behavior* $\rightarrow$ *Self Esteem*
1. *Peer Attachment* $\rightarrow$ *Empathy* $\rightarrow$ *Prosocial Behavior*
1. *Empathy* $\rightarrow$ *Prosocial Behavior* $\rightarrow$ *Self Esteem*

1. *Peer Attachment* $\rightarrow$ *Aggressive Behavior* $\rightarrow$ *Self Esteem*
1. *Peer Attachment* $\rightarrow$ *Empathy* $\rightarrow$ *Aggressive Behavior*
1. *Empathy* $\rightarrow$ *Aggressive Behavior* $\rightarrow$ *Self Esteem*

***Direct Effects***

1. *Parent Attachment* $\rightarrow$ *Self Esteem*
1. *Parent Attachment* $\rightarrow$ *Prosocial Behavior*
1. *Parent Attachment* $\rightarrow$ *Aggressive Behavior*

1. *Peer Attachment* $\rightarrow$ *Self Esteem*
1. *Peer Attachment* $\rightarrow$ *Prosocial Behavior*
1. *Peer Attachment* $\rightarrow$ *Aggressive Behavior*

1. *Empathy* $\rightarrow$ *Self Esteem*

***Total Effects***

</details>

---
