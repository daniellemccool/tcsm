## At-Home Exercises

```{r, include = FALSE}
library(kableExtra)
library(foreign)
```

These exercise is based on the second reading for this week:

Kestilä, E. (2006). Is there demand for radical right populism in the Finnish 
electorate? *Scandinavian Political Studies 29*(3), 169--191. 
 
The data for this practical, were collected during the first round of the 
European Social Survey (ESS). The ESS is a repeated cross-sectional survey
administered in 32 European countries. The first wave was collected in 2002, and 
two new waves have been collected each year since. You can find more info and 
access the data at [https://www.europeansocialsurvey.org]. 

The data we will analyze for this practical are contained in the file named 
*ESSround1-a.sav*. This file contains data for all respondents, but only includes 
those variables that you will need to complete the following exercises. 

---

###

Load the *ESSround1-a.sav* dataset into R.

- Inspect the data after loading to make sure everything went well.

```{r, eval = FALSE}
## Load the 'foreign' package:
library(foreign)

## Read the 'ESSround1-a.sav' ess into a data frame called 'ess': 
ess <- read.spss("ESSround1-a.sav", to.data.frame = TRUE)

## Inspect the result:
dim(ess)
summary(ess)
str(ess)
```

When you inspect the data, you may notice that almost all variables are 
represented as factors. If so, good eyes! We'll come back to this issue a 
little later.

```{r, echo = FALSE}
dataDir <- "../../data/" ####################################################
ess1 <- read.spss(paste0(dataDir, "ESSround1-a.sav"), to.data.frame = TRUE)
ess2 <- read_spss(paste0(dataDir, "ESSround1-a.sav"))


str(ess2)
```

<details>
  <summary><b>Click here for a description of the variables.</b></summary>

```{r, results = "asis", echo = FALSE}
desc <- c(
  "Title of dataset",
  "ESS round",
  "Edition",
  "Production date",
  "Country",
  "Respondent's identification number",
  "Trust in the legal system",
  "Trust in the police",
  "Trust in the United Nations",
  "Trust in the European Parliament",
  "Trust in country's parliament",
  "State of health services in country nowadays",
  "State of education in country nowadays",
  "How satisfied with present state of economy in country",
  "How satisfied with the national government",
  "How satisfied with the way democracy works in country",
  "Politicians interested in votes rather than peoples opinions",
  "Politicians in general care what people like respondent think",
  "Trust in politicians",
  "Allow many/few immigrants of same race/ethnic group as majority",
  "Allow many/few immigrants of different race/ethnic group from majority",
  "Allow many/few immigrants from richer countries in Europe",
  "Allow many/few immigrants from poorer countries in Europe",
  "Allow many/few immigrants from richer countries outside Europe",
  "Allow many/few immigrants from poorer countries outside Europe",
  "Qualification for immigration: christian background",
  "Qualification for immigration: be white",
  "Average wages/salaries generally brought down by immigrants",
  "Immigrants harm economic prospects of the poor more than the rich",
  "Immigrants take jobs away in country or create new jobs",
  "Taxes and services: immigrants take out more than they put in or less",
  "Immigration bad or good for country's economy",
  "Country's cultural life undermined or enriched by immigrants",
  "Immigrants make country worse or better place to live",
  "Immigrants make country's crime problems worse or better",
  "Richer countries should be responsible for accepting people from poorer countries",
  "Better for a country if almost everyone share customs and traditions",
  "Better for a country if a variety of different religions",
  "Country has more than its fair share of people applying refugee status",
  "People applying refugee status allowed to work while cases considered",
  "Government should be generous judging applications for refugee status",
  "Most refugee applicants not in real fear of persecution own countries",
  "Financial support to refugee applicants while cases considered",
  "Granted refugees should be entitled to bring close family members",
  "Gender",
  "Year of birth",
  "Highest level of education",
  "Years of full-time education completed",
  "How interested in politics",
  "Placement on left right scale"
  )

data.frame(Variable = names(ess), Description = desc) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```

</details>

---

The `ess` dataset contains much more information than Kestilä (2006) used. 
Kestilä only analyzed data from the following ten countries:

- Austria
- Belgium
- Denmark
- Finland
- France
- Germany
- Italy
- Netherlands
- Norway
- Sweden

So, our first task is to subset the data to only the relevant population.  

As explained in \@ref(logicalSubsetting), we can select rows from a dataset
based on logical conditions. In this case, we want to select only rows from the
10 countries listed above.

---

###

Subset the data to include only the 10 countries analyzed by Kestilä (2006).

- Inspect the subsetted data to check that everything went well.

*Hint:* Use the `%in%` operator to create a logical vector that indicates which
elements of the `cntry` variable are *in* the set of target counties.

<details>
  <summary>Click for explanation</summary>

```{r, echo = TRUE}
## Create a character vector naming the target countries:
targets <- c("Austria", 
             "Belgium", 
             "Denmark", 
             "Finland", 
             "France", 
             "Germany", 
             "Italy", 
             "Netherlands", 
             "Norway", 
             "Sweden")

## Select only those rows that come from a target country:
ess <- ess[ess$cntry %in% targets, ]

## Inspect the result:
dim(ess)
table(ess$cntry)
```

</details>

---

Before we can analyze the data, we need to screen them for problems. At this 
point, we won't get into the nitty-gritty of outlier analysis and data
cleaning. We must, however, ensure that the variables we want to analyze are 
formatted correctly (e.g., interval and ratio variables should be numeric, 
nominal variables should be factors).

---

###

Screen the data to see if the variables are formatted correctly.

<details>
  <summary>Click for explanation</summary>

```{r, echo = TRUE}
library(tidySEM)

## Check the data structure:
str(ess)

## Compute descriptive statistics:
descriptives(ess)

## Check the levels of one of the spurious factors:
levels(ess$trstlgl)
```

As noted above, one thing you might notice when inspecting the `ess` data is
that nearly all variables are stored as factors.

</details>

---

###

Correct any formatting issues that you discovered above.

<details>
  <summary>Click for explanation</summary>

In keeping with conventions, we will treat ordinal Likert-type rating scales
with five or more levels as continuous. Consequently, we need to convert these
variables from factors to numeric vectors.

We can convert a factor to a numeric variable using the `as.numeric()` function. However, in this case, we have `r 45-7` variables to convert - that's a lot of code.

Thankfully, there is a function to apply this transformation to each column of the data: `lapply()`, short for list apply. This function takes each list element (column of the `data.frame`), and applies the function `as.numeric()` to it:

```{r, echo = TRUE}
ess[7:44] <- lapply(ess[7:44], as.numeric)
?read.spss
```

`r if(knitr::is_html_output()){"\\details"}`

###

Aside from screening variables by looking at summary statistics, we can also plot their distributions. You already know how to do this for one single variable.
Yet it is not very difficult to plot all variables in a data.frame.
To do this, we need to turn the data from "wide format" (one column per variable)
into "long format" (one column with the variable names, one column with the values).
The package `tidyr` has a convenient function to reshape data to long format:
`pivot_longer()`.

First, make a long data.frame containing variables 7:44.

```{r, eval = FALSE, echo = TRUE}
install.packages("tidyr")
library(tidyr)
ess_plot <- ess[7:44]
ess_plot <- pivot_longer(ess_plot, names(ess_plot))
```
```{r, echo = FALSE}
library(tidyr)
ess_plot <- ess[7:44]
ess_plot <- pivot_longer(ess_plot, names(ess_plot))
```

Next, we can plot the data - using `geom_histogram()`, `geom_density()` or `geom_boxplot()` as before. A new additional function allows us to make separate plots for each variable: `+ facet_wrap(~name, scales = "free_x")`.

<details>
  <summary>Click for explanation</summary>

```{r, echo = TRUE}
library(ggplot2)
ggplot(ess_plot, aes(x = value)) + geom_histogram() + facet_wrap(~name, scales = "free_x")
```

Notice the fact that you can see that the scales are actually categorical (because of the gaps between bars), and that most variables look relatively normally distributed despite being categorical. It's probably fine to treat them as continuous.
`r if(knitr::is_html_output()){"\\details"}`

###

Check the scale descriptives table again. Are there any incorrectly coded missing value labels, or other inexplicable values?

###

The first step in re-analyzing data is replicating the results from the paper by 
Kestilä. Run a Principal Component Analysis using `psych::principal()`, and 
choose the exact same specification as Kestilä concerning estimation method, 
rotation etc. Do two analyses: one for trust in politics, and one for attitudes towards immigration. Remember that you can view the help file for `psych::principal()` by running
`?psych::principal`.

*Hint: Use* `psych::principal()`

<details>
  <summary>Click for explanation</summary>

#### Trust in politics

Kestilä extracted three components, with VARIMAX rotation. When we print the results, we can hide all factor loadings smaller than the smallest one in their table, to make it easier to read:
  
```{r, echo = TRUE}
library(psych)
pca_trust <- principal(ess[, 7:19], nfactors = 3, rotate = "varimax")
print(pca_trust, cut = .3, digits =3)
```

For attitude towards immigration, Kestilä extracted five components, with VARIMAX rotation:
  
```{r, echo = TRUE}
library(psych)
pca_att <- principal(ess[, 20:44], nfactors = 5, rotate = "varimax")
print(pca_att, cut = .3)
```
`r if(knitr::is_html_output()){"\\details"}`

###

<!-- Video here about extracting factor scores-->
Extract the PCA factor scores from the results objects, and add them to the data.frame. Give the PCA scores informative names, based on your interpretation of the factor loadings, so that you understand what they summarize. 

*Hint: Use* `$; colnames(); cbind()`

<details>
  <summary>Click for explanation</summary>
Extracting factor scores

The factor scores are inside of the results objects. Use the `$` operator to access them:

```{r, echo = TRUE}
head(pca_att$scores)
```

We're going to give these factor scores some informative names, and add them to our data.frame. **You should give them different, informative names based on the meaning of the factors!**

```{r, echo = TRUE}
# Print names
colnames(pca_att$scores)
# Change names
colnames(pca_att$scores) <- c("Att1", "Att2", "Att3", "Att4", "Att5")
colnames(pca_trust$scores) <- c("Trust1", "Trust2", "Trust3")
# Add columns
ess <- cbind(ess, pca_trust$scores, pca_att$scores)
```

`r if(knitr::is_html_output()){"\\details"}`


###

Are you able to replicate her results? 

<details>
  <summary>Click for explanation</summary>
  No, probably not. The team of teachers was unable to reproduce this analysis, even though it should be pretty easy to do so...

`r if(knitr::is_html_output()){"\\details"}`


###

Save your syntax and bring your data and syntax to the practical on Thursday.

